# Upgrade Nebula Graph clusters created with Nebula Operator

This topic introduces how to upgrade a Nebula Graph cluster created with Nebula Operator.

## Prerequisites

You have created a Nebula Graph cluster. For details, see [Create a Nebula Graph cluster with Kubectl](3.deploy-nebula-graph-cluster/3.1create-cluster-with-kubectl.md)ã€‚

The version of the Nebula Graph cluster to be upgraded in this topic is `2.5.1`, and its YAML file name is `apps_v1alpha1_nebulacluster.yaml`.

## Limits

- Only Nebula Graph clusters created with Nebula Operator are supported.

- Only Nebula Graph versions 2.5.x to 2.6.x are supported for upgrade.

## Steps

1. Check the image version of the services in the cluster.

  ```bash
  kubectl get pods -l app.kubernetes.io/cluster=nebula  -o jsonpath="{.items[*].spec.containers[*].image}" |tr -s '[[:space:]]' '\n' |sort |uniq -c
  ```

  Output:

  ```bash
        1 vesoft/nebula-graphd:v2.5.1
        1 vesoft/nebula-metad:v2.5.1
        3 vesoft/nebula-storaged:v2.5.1  
  ```

2. Edit the `apps_v1alpha1_nebulacluster.yaml` file by changing the values of all the `version` parameters from v2.5.1 to {{nebula.branch}}.

  The modified YAML file reads as follows:

  ```yaml
  apiVersion: apps.nebula-graph.io/v1alpha1
  kind: NebulaCluster
  metadata:
      name: nebula
  spec:
      graphd:
          resources:
              requests:
                  cpu: "500m"
                  memory: "500Mi"
              limits:
                  cpu: "1"
                  memory: "1Gi"
          replicas: 2
          image: vesoft/nebula-graphd
          version: {{nebula.branch}} //Change the value from v2.5.1 to {{nebula.branch}}.
          service:
              type: NodePort
              externalTrafficPolicy: Local
          storageClaim:
              resources:
                  requests:
                      storage: 2Gi
              storageClassName: local-path
      metad:
          resources:
              requests:
                  cpu: "500m"
                  memory: "500Mi"
              limits:
                  cpu: "1"
                  memory: "1Gi"
          replicas: 1
          image: vesoft/nebula-metad
          version: {{nebula.branch}} //Change the value from v2.5.1 to {{nebula.branch}}.
          storageClaim:
              resources:
                  requests:
                      storage: 2Gi
              storageClassName: local-path
      storaged:
          resources:
              requests:
                  cpu: "500m"
                  memory: "500Mi"
              limits:
                  cpu: "1"
                  memory: "1Gi"
          replicas: 3
          image: vesoft/nebula-storaged
          version: {{nebula.branch}} //Change the value from v2.5.1 to {{nebula.branch}}.
          storageClaim:
              resources:
                  requests:
                      storage: 2Gi
              storageClassName: local-path
      reference:
          name: statefulsets.apps
          version: v1
      schedulerName: default-scheduler
      imagePullPolicy: IfNotPresent
  ```

3. Run the following command to apply the version update to the cluster CR.
   
  ```bash
  kubectl apply -f apps_v1alpha1_nebulacluster.yaml
  ```

4. After waiting for about 2 minutes, run the following command to see the image versions of the services in the cluster have been changed to {{nebula.branch}}.
   
  ```bash
  kubectl get pods -l app.kubernetes.io/cluster=nebula  -o jsonpath="{.items[*].spec.containers[*].image}" |tr -s '[[:space:]]' '\n' |sort |uniq -c
  ```

  Output:

  ```bash
        1 vesoft/nebula-graphd:{{nebula.branch}}
        1 vesoft/nebula-metad:{{nebula.branch}}
        3 vesoft/nebula-storaged:{{nebula.branch}}  
  ```