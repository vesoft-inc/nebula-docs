# UPSERT EDGE

`UPSERT` is a combination of `UPDATE` and `INSERT`. Use `UPSERT EDGE` to update properties of an edge if it exists or insert a new edge if it does not exist.

The performance of `UPSERT` is much lower than that of `INSERT`, because `UPSERT` is a read-modify-write serialization operation at the partition level.

!!! danger

    Don't use `UPSERT` for scenarios with highly concurrent writes. Use `UPDATE` or `INSERT` instead.

## Syntax

```ngql
UPSERT EDGE ON <edge_type>
<src_vid> -> <dst_vid> [@rank]
SET <update_prop>
[WHEN <condition>]
[YIELD <properties>]
```

| Field | Required | Description | Example |
|-|-|-|-|
| `ON <edge_type>` | Yes | Specifies the type of the edge. The properties to be updated must be on this tag. | `ON serve` |
| `<src_vid>` | Yes | Specifies the source vertex ID of the edge. | `"player100"` |
| `<dst_vid>` | Yes | Specifies the destination vertex ID of the edge. | `"team204"` |
| `<rank>` | No | Specifies the rank of the edge. | `10` |
| `SET <update_prop>` | Yes | Specifies the properties to be updated and how they will be updated. | `SET start_year = start_year +1` |
| `WHEN <condition>` | No | Specifies the filter conditions. If `<condition>` evaluates to `false`, the `SET` clause does not take effect. | `WHEN end_year < 2010` |
|`YIELD <output>`|No| Specifies the output format of the statement. | `YIELD start_year AS Start_Year` |

## Insert an edge if it does not exist

If an edge does not exist, it is created no matter the conditions in the `WHEN` clause are met or not.

The property values of the new edge depends on:

* Whether the conditions are met
* How the `SET` clause is defined
* The default value of the properties

For example, if:

* The edge to be inserted will have properties `start_year` and `end_year` based on the edge type `serve`.
* The `SET` clause specifies that `end_year = 2021`.

Then the property values in different cases are listed as follows:

| Are `WHEN` conditions met | If properties has default values | Value of `start_year` | Value of `end_year` |
| - | - | - | - |
| Yes | Yes | The default value | `2021` |
| Yes | No | `NULL` | `30` |
| No | Yes | The default value | The default value |
| No | No | `NULL` | `NULL` |

Here are some examples:

```ngql
// Check if the following three vertices has any outgoing serve edge.
nebula> GO FROM "player666", "player667", "player668" \
        OVER serve \
        YIELD serve.start_year, serve.end_year;
Empty set

// The result Empty set indicates that no edge exists.

nebula> UPSERT EDGE on serve "player666" -> "team200"@0 \
        SET end_year = 2021 \
        WHEN end_year = 2010 \
        YIELD start_year, end_year;
+------------+----------+
| start_year | end_year |
+------------+----------+
| 1998       | 2016     |
+------------+----------+

nebula> UPSERT EDGE on serve "player668" -> "team204"@0 \
        SET start_year = start_year + 1 \
        WHEN end_year > 2010 \
        YIELD start_year, end_year;



```





















- If the edge does not exist, a new edge is created no matter whether the condition in the `WHEN` clause is met or not. The properties not specified by the `SET` statement use the default property values. If there are no default values, an error is returned.
- If the edge exists and the `WHEN` condition is met, the edge is updated.
- If the edge exists and the `WHEN` condition is not met, NebulaÂ Graph does nothing.

Consider the following example:

```ngql
//Insert a new edge.
nebula> INSERT EDGE serve(start_year, end_year) VALUES "player100" -> "team200":(1997, 2016);  -- 

nebula> UPSERT EDGE "player100" -> "team200" OF serve SET start_year = serve.start_year + 2 WHEN serve.end_year == 2016 YIELD serve.start_year AS Start, serve.end_year AS End;
+-------+------+
| Start | End  |
+-------+------+
| 1999  | 2016 |
+-------+------+

nebula> FETCH PROP ON serve "player100" -> "team200";
+-----------------------------------------------------------------------+
| edges_                                                                |
+-----------------------------------------------------------------------+
| [:serve "player100"->"team200" @0 {end_year: 2016, start_year: 1999}] |
+-----------------------------------------------------------------------+
```
