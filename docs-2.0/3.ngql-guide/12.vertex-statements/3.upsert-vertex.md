# UPSERT VERTEX

`UPSERT` is a combination of `UPDATE` and `INSERT`.  Use `UPSERT VERTEX` to update properties of a vertex if it exists or insert a new vertex if it does not exist.

!!! note

    An `UPSERT VERTEX` statement can only update properties on **ONE TAG** of a vertex.

The performance of `UPSERT` is much lower than that of `INSERT`, because `UPSERT` is a read-modify-write serialization operation at the partition level.

!!! danger

    Don't use `UPSERT` for scenarios with highly concurrent writes.

## Syntax

```ngql
UPSERT VERTEX ON <tag_name> <vid>
SET <update_prop>
[WHEN <condition>] [YIELD <output>]
```

| Field | Required | Description | Example |
|-|-|-|-|
| `ON <tag_name>` | Yes | Specifies the tag of the vertex. The properties to be updated must be on this tag. | `ON player` |
| `<vid>` | Yes | Specifies the ID of the vertex to be updated or inserted. | `"player100"` |
| `SET <update_prop>` | Yes | Specifies the properties to be updated and how they will be updated. | `SET age = age +1` |
| `WHEN <condition>` | No | Specifies the filter conditions. | `WHEN name == "Tim"` |
|`YIELD <output>`|No| Specifies the output format of the statement. | `YIELD name AS Name` |

<!--## Implementation rules

- If the vertex does not exist, The property columns not specified by the `SET` statement use the default values of the columns. If there are no default values, an error is returned.
- If the vertex exists and the `WHEN` condition is met, the vertex is updated.
- If the vertex exists and the `WHEN` condition is not met, NebulaÂ Graph does nothing.
-->

## Insert a vertex if it does not exist

If a vertex does not exist, it is created no matter the conditions in the `WHEN` clause are met or not.

The property values of the new vertex depends on:

* Whether the conditions are met
* How the `SET` clause is defined
* The default value of the properties

For example, if:

* The vertex to be inserted will have properties `name` and `age` based on tag `player`.
* The `SET` clause specifies that `age = 30`.

The property values in different cases are listed as follows:

| Are `WHEN` conditions met | If properties has default values | Value of `name` | Value of `age` |
| - | - | - | - |
| Yes | Yes | The default value | `30` |
| Yes | No | `NULL` | `30` |
| No | Yes | `NULL` | `NULL` |
| No | No | `NULL` | `NULL` |

```ngql
nebula> FETCH PROP ON player "player666", "player667";
Empty set

nebula> UPSERT VERTEX ON player "player666" \
        SET age = 30 \
        WHEN name == "Joe" \
        YIELD name AS Name, age AS Age;
+----------+----------+
| Name     | Age      |
+----------+----------+
| __NULL__ | __NULL__ |
+----------+----------+

nebula> UPSERT VERTEX ON player "player667" \
        SET age = 31 \
        YIELD name AS Name, age AS Age;
+----------+-----+
| Name     | Age |
+----------+-----+
| __NULL__ | 31  |
+----------+-----+
```

## Update a vertex if it exists

<!-- 


```ngql
nebula> INSERT VERTEX player(name, age) VALUES "player111":("Ben Simmons", 22); -- Insert a new vertex.
nebula> UPSERT VERTEX "player111" SET player.name = "Dwight Howard", player.age = $^.player.age + 11 WHEN $^.player.name == "Ben Simmons" AND $^.player.age > 20 YIELD $^.player.name AS Name, $^.player.age AS Age; -- Do an upsert operation on the vertex.

+-----------------+-----+
| Name            | Age |
+-----------------+-----+
| "Dwight Howard" | 33  |
+-----------------+-----+
```

```ngql
// An empty set is returned. Because vertex "player123" does not exist.
nebula> FETCH PROP ON * "player123";
Empty set (Time spent: 3.069/4.382 ms)
nebula> UPSERT VERTEX "player123" SET player.age = $^.player.age + 1;
```

If the vertex "player123" does not exist and the default value of age is `NULL`, the `player.age` of vertex "player123" is `NULL`. If `player.age` has a default value, the `player.age` of vertex "player123" is the default value plus one.

```ngql
nebula> CREATE TAG person(followers int, age int DEFAULT 0); -- Create example tag person

nebula> UPSERT VERTEX "300" SET person.followers = $^.person.age + 1,  person.age = 8; -- the number of followers is 1, age is 8

nebula> UPSERT VERTEX "300" SET person.age = 8, person.followers = $^.person.age + 1; -- the number of followers is 9, age is 8
```

-->