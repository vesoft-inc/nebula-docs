# Manage Zone

The Zone is a logical rack of storage nodes in a NebulaGraph cluster. It divides multiple storage nodes into manageable logical areas to achieve resource isolation. At the same time, you can control the Graph service to access the replica data in the specified Zone to reduce traffic consumption and improve access efficiency. This article describes how to use the Zone feature.

## Principle

Storage nodes can be added to a Zone. When creating a graph space, you can specify a list of Zones. The graph space is created and stored on the storage nodes added in these Zones. Partition replicas are evenly stored in the Zones, as shown in the following figure.

![Zone](https://docs-cdn.nebula-graph.com.cn/figures/zone1.png)

In the above figure, the six machines with the running storage service are grouped in pairs and added to three Zones. When creating a graph space S1 with a partition replica number of 3 in these three Zones, these partition replicas are evenly stored in Zone1 ~ Zone3.

## Scenarios

- Resource isolation. You can create a graph space on specified storage nodes to achieve resource isolation.
- Rolling upgrade. You need to stop one or more servers to update them, and then put them into use again until all servers in the cluster are updated to the new version.
- Cost saving. Allocate different graph spaces to different Zones, and control the client to access the replica data in the specified Zone to reduce traffic consumption and improve access efficiency.


## Notes

- Make sure that the cluster is empty before enabling the Zone feature. To enable the Zone feature, see **Enable Zone** below.
- A storage node can only belong to one Zone, but a Zone can contain multiple different storage nodes.
- Deleting a Zone is not supported.
- Modifying the name of a Zone is not supported.

## Enable Zone 

1. In the configuration file `nebula-metad.conf` of the Meta service, operate as follows:
  
  1. Modify the value of `--enable_zones` to `true` to enable the Zone feature. The default value is `false`.
  2. Manually add the `--zone_list` field and set its value to the name(s) of the Zone(s) to be added, such as `--assigned_zone=zone1, zone2, zone3`.

  !!! danger

      Once the value of `--zone_list` is configured and the Meta service is started, it cannot be modified, otherwise, the Meta service will fail to restart.

  !!! note

      If the name of a Zone contains special characters (excluding underscores), reserved keywords, or starts with a number, you need to enclose the Zone name in backticks (`) when specifying the Zone name in a query statement; the Zone name cannot contain English periods (.); multiple Zone names are separated by commas (,).
   
  For more information about the Meta configuration file, see [Meta service configuration](../5.configurations-and-logs/1.configurations/2.meta-config.md).

2. Restart the Meta service.


## Specify the Zone to be accessed by the Graph service

1. Enable the Zone feature. For details, see **Enable Zone** above.
2. In the configuration file `nebula-graphd.conf` of the Graph service, add the following configuration:
  
  1. Add the `--assigned_zone` field and set its value to the name of the Zone to be accessed, such as `--assigned_zone=zone1`.
   
    !!! note
      
      - Different Graph services can set different values for `--assigned_zone`, but the value of `--assigned_zone` must be one of the values in `--zone_list`.
      - The value of `--assigned_zone` is a string and does not support English commas (,).
      - When the value of `--assigned_zone` is empty, it indicates that all Zones are accessed.
  
  2. Set `--prioritize_intra_zone_reading=true` to enable the function of accessing the specified Zone.

    !!! caution

      It is recommended that the values of `--prioritize_intra_zone_reading` in different Graph services be consistent, otherwise, the load of Storage nodes will be unbalanced and unknown risks will occur.

  For details on the Graph configuration, see [Graph service configuration](../5.configurations-and-logs/1.configurations/3.graph-config.md).

3. Restart the Graph service.
   

## Zone-related commands

!!! note

    Make sure that the Zone feature is enabled and the `--zone_list` is configured before executing Zone-related commands. For details, see **Enable Zone** above.

### View all Zone information

```ngql
nebula> SHOW ZONES;
+--------+-----------------+------+
| Name   | Host            | Port |
+--------+-----------------+------+
| "az1"  | "192.168.8.111" | 9779 |
| "az1"  | "192.168.8.112" | 9779 |
| "az2"  | ""              | 0    |
| "az3"  | ""              | 0    |
+--------+-----------------+------+
```

!!! note

    Run `SHOW ZONES` in the current graph space to view all Zone information, instead of the Zone information of the current graph spaces. The Zone information includes the name of the Zone, the IP address and the port number of the storage node in the Zone.

### View the specified Zone

```ngql
DESCRIBE ZONE <zone_name>;
DESC ZONE <zone_name>;
```

For example:

```ngql
nebula> DESC ZONE az1
+-----------------+------+
| Hosts           | Port |
+-----------------+------+
| "192.168.8.111" | 7779 |
| "192.168.8.111" | 9779 |
+-----------------+------+
```

### Create a space in the specified Zone

```ngql
CREATE SPACE IF NOT EXISTS  (
    [partition_num = <partition_number>,]
    [replica_factor = <replica_number>,]
    vid_type = {FIXED_STRING(<N>) | INT[64]}
    )
    [COMMENT = '<comment>'] 
    [ON <zone_list>];
```

!!! note

    - The Zone specified when creating a graph space must be one or more of the values in the `--zone_list` of the Meta configuration file, otherwise the graph space cannot be created.
    - The Zone specified when creating a graph space must contain at least one Storage node, otherwise the graph space cannot be created.
    - The number of partition replicas specified when creating a graph space must be less than or equal to the number of Zones, otherwise, the graph space cannot be created.


!!! caution

    It is not recommended to create a graph space without specifying a Zone when the Zone feature is enabled and the Graph service is configured to access the specified Zone (set `--assigned_zone`). This will result in the inability to query the replica data distributed in other Zones because the Graph service will only access the replica data in the specified Zone, and creating a graph space without specifying a Zone will result in the distribution of replicas in other Zones.

For example:

```ngql
nebula> CREATE SPACE IF NOT EXISTS my_space_1 (vid_type=FIXED_STRING(30)) on az1
```

### View the Zone to which the specified graph space belongs

```ngql
DESC SPACE <space_name>;
```

For example:

```ngql
nebula> DESC SPACE my_space_1
+----+--------------+------------------+----------------+---------+------------+--------------------+---------+---------+
| ID | Name         | Partition Number | Replica Factor | Charset | Collate    | Vid Type           | Zones   | Comment |
+----+--------------+------------------+----------------+---------+------------+--------------------+---------+---------+
| 22 | "my_space_1" | 10               | 1              | "utf8"  | "utf8_bin" | "FIXED_STRING(30)" | ["az1"] |         |
+----+--------------+------------------+----------------+---------+------------+--------------------+---------+---------+
```

### Add Storage nodes to the specified Zone

```ngql
ADD HOSTS <ip>:<port> [,<ip>:<port> ...] INTO ZONE <new_zone_name>;
```

For example: 

```ngql
nebula> ADD HOSTS 192.168.8.111:9779,192.168.8.112:9779 INTO ZONE az1;
```

### Migrate data from the Storage nodes in the specified Zone to other Storage nodes 

```ngql
BALANCE IN ZONE REMOVE <ip>:<port> [,<ip>:<port> ...]
```

!!! note

    - You must specify a space before executing this command.
    - Make sure that the number of other Storage nodes is sufficient to meet the set number of partition replicas. When the number of Storage nodes is insufficient, the removal will fail. Run `SHOW JOBS <job_id>` to view the status of the removal task. When `FINISHED` is returned, the removal task is completed.


For example: 

```ngql
nebula> USE my_space_1;
nebula> BALANCE IN ZONE REMOVE 192.168.8.111:9779;
+------------+
| New Job Id |
+------------+
| 34         |
+------------+

# To view the status of the removal task:
nebula> SHOW JOBS 34
+--------+----------------+------------+----------------------------+----------------------------+
| Job Id | Command        | Status     | Start Time                 | Stop Time                  |
+--------+----------------+------------+----------------------------+----------------------------+
| 33     | "DATA_BALANCE" | "FINISHED" | 2023-09-01T08:03:16.000000 | 2023-09-01T08:03:16.000000 |
+--------+----------------+------------+----------------------------+----------------------------+
```

### Drop Storage nodes from the specified Zone 

```ngql
DROP HOSTS <ip>:<port> [,<ip>:<port> ...];
```

!!! note

    You cannot directly drop a Storage node that is in use. You need to first drop the associated graph space before dropping the Storage nodes. See [drop space](../3.ngql-guide/9.space-statements/5.drop-space.md) for details.

For example: 

```ngql
nebula> DROP HOSTS 192.168.8.111:9779;
```

### Balance the data in the specified Zone

```ngql
BALANCE IN ZONE;
```

!!! note

    Specify a space before executing this command.

For example: 

```ngql
nebula> USE my_space_1;
nebula> BALANCE IN ZONE;
```

